{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}
<!-- book-detail.hmtl code starts here -->
<div class="py-3 text-center">
    <h1>{{ book.title }}</h1>
</div>
<!-- Book detail -->
<div class="py-3">
    <div class="container">
        <div class="row">
            <div class="col-12 col-sm-6 py-4">
                <div class="book-info-image-container text-center">
                    {% if 'placeholder' not in book.front_cover.url %}
                    <img class="card-img-top" src=" {{ book.front_cover.url }}" alt="{{ book.title }}">
                    {% else %}
                    <img class="card-img-top" src="{% static 'images/placeholder.webp' %}" alt="placeholder image">
                    {% endif %}
                </div>
            </div>
            <div class="col-12 col-sm-6 text-center text-sm-start pt-4 text-center">
                <p><span class="bold">Author{% if book.author.all.count > 1 %}s{% endif %}</span>:
                    {{ book.author.all|join:", " }}</p>
                <p><span class="bold">Genre{% if book.genres.all.count > 1 %}s{% endif %}</span>:
                    {{ book.genres.all|join:", " }}</p>
                <p><span class="bold">First Published</span>: {{ book.published }}</p>
                <p><span class="bold">Language</span>: {{ book.language }}</p>
                <p><span class="bold">No. of pages</span>: {{ book.pages}}</p>
            </div>
            <div class="col-12 text-start">
                <p class="bold">Synopsis:</p>
                <p>{{ book.synopsis }}</p>
                <p class="bold">Your status: {{ user_status.get_status_display }}</p>
            </div>
        </div>
        <div class="row mb-2">
            <div class="col-12 mb-2">
                {% if user_status and user_status.status == 1 %}
                <button class="button-2 me-3 border-0">Remove from wishlist</button>
                {% else %}
                <form method="POST" id="add_to_wishlist" action="{% url 'add_to_wishlist' username=request.user.username slug=book.slug %}">
                    <button class="button-2 me-3 border-0" type="submit">Add to wishlist</button>
                    {% csrf_token %}
                </form>
                {% endif %}
            </div>
            <div class="col-12 mb-2">
                {% if user_status and user_status.status == 2 %}
                <button class="button-2 me-3 border-0">Remove from currently reading</button>
                {% else %}
                <form method="POST" id="add_to_currently_reading" action="{% url 'add_to_currently_reading' username=request.user.username slug=book.slug %}">
                    <button class="button-2 me-3 border-0" type="submit">Add to currently reading</button>
                    {% csrf_token %}
                </form>
                {% endif %}
            </div>
            <div class="col-12 mb-2">
                {% if user_status and user_status.status == 3 %}
                <button class="button-2 me-3 border-0">Remove from read</button>
                {% else %}
                <form method="POST" id="add_to_read" action="{% url 'add_to_read' username=request.user.username slug=book.slug %}">
                    <button class="button-2 me-3 border-0" type="submit">Add to read</button>
                    {% csrf_token %}
                </form>
                {% endif %}
            </div>
            <div class="col-12 mb-2">
                {% if user_status and user_status.status == 4 %}
                <button class="button-2 me-3 border-0">Remove from DNF</button>
                {% else %}
                <form method="POST" id="add_to_dnf" action="{% url 'add_to_dnf' username=request.user.username slug=book.slug %}">
                    <button class="button-2 me-3 border-0" type="submit">Add to DNF</button>
                    {% csrf_token %}
                </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>
<div class="d-flex justify-content-center">
    <hr>
</div>
<!-- User's rating and review. Options to add if they don't have one-->
<h2 class="text-center">Your review and rating</h2>
<div class="container">
    <div class="row">
        <div class="col-12 col-md-8 mb-3">
            {% if user_review %}
            <p>{{ user_review.review|truncatechars:100 }}</p>
            <button class="button-2 me-3 border-0">Edit review</button>
            <button class="button-2 me-3 border-0">Delete review</button>
            {% else %}
            <form id="add_review_form" method="POST" action="{% url 'add_review' slug=book.slug %}">
                {{ add_review_form | crispy }}
                {% csrf_token %}
                <button type="submit" class="button">Add Review</button>
            </form>
            {% endif %}
        </div>
        <div class="col-12 col-md-4 mb-3">
            {% if user_rating %}
            <p>{{ user_rating.rating }}</p>
            <button class="button-2 me-3 border-0">Edit rating</button>
            <button class="button-2 me-3 border-0">Delete rating</button>
            {% else %}
            <form id="add_review_form" method="POST" action="{% url 'add_rating' slug=book.slug %}">
                {{ add_rating_form | crispy }}
                {% csrf_token %}
                <button type="submit" class="button">Add Rating</button>
            </form>
            {% endif %}
        </div>
    </div>
</div>
<div class="d-flex justify-content-center">
    <hr>
</div>
<!-- All reviews and ratings -->
<div class="container">
    <div class="row">
        <div class="col-12 col-md-8">
            <h3 class="text-center">All Reviews</h3>
            {% for review in review %}
            <div class="review-box mb-5 pt-4 px-3 text-start">
                <p>{{ review.review|truncatechars:100 }}</p>
                {% if review.rating_with_review %}
                <p class="p-small bold">Rating: {{ review.rating_with_review.rating }}/5</p>
                {% else %}
                <p class="p-small bold">No rating given</p>
                {% endif %}
                <p class="p-small">{{ review.created_on }}</p>
                <div class="mb-3">
                    <a href="{% url 'review_detail' slug=review.slug %}" class="button-2">Full review</a>
                </div>
            </div>
            {% empty %}
            <p class="text-center">No reviews yet</p>
            {% endfor %}
        </div>
        <div class="col-12 col-md-4">
            <h3 class="text-center">All Ratings</h3>
            {% for rating in rating %}
            <p>{{ rating.author.username}}'s rating:</p>
            <p class="bold">{{ rating.rating }}/5</p>
            {% empty %}
            <p class="text-center">No ratings yet</p>
            {% endfor %}
        </div>
    </div>
</div>
<div class="d-flex justify-content-center">
    <hr>
</div>
<div class="text-center pb-4">
    <h3 class="pb-3">Choose your next book or see all the reviews:</h3>
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-12">
                <a class="button" aria-label="Link to go to the all reviews page" href="{% url 'book_overview' %}">All
                    Books</a>
                <a class="button" aria-label="Link to go to the all reviews page" href="{% url 'all_reviews' %}">All
                    Reviews</a>
            </div>
        </div>
    </div>
</div>
<!-- book-details.hmtl code ends here -->
{% endblock content %}